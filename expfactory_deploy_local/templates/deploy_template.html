<html>
  {# load static from staticfiles #}
  <head>
    <title>The Experiment Factory</title>
    <meta charset="utf-8" />
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js""></script>
    <!-- script and style tags generated from expfactory.vm.get_stylejs. defaults to
         js and css in experiment's expfactory-experiment directory
    -->
    {{ experiment_load | safe }}

  </head>
<body>
  <button id="start_experiment_button" type="button" class="btn hidden" hidden></button>
  <script>
    {% if require_cookie_csrf %}
     $(function() {
       <!-- {# include "experiments/serve_battery_cookie.html" #} -->
       function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
                  for (var i = 0; i < cookies.length; i++) {
                      var cookie = jQuery.trim(cookies[i]);
                      // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) == (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
          return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        // Worker not allowed to proceed without cookies
        if (csrftoken==undefined){
          document.location = "/cookie/"
        }

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
      {% endif %}


        <!-- {# include "experiments/preview_battery_runjs.html" #} -->
        var uniqueId = "{{ uniqueId }}";

        /*Just to store task data as we go*/
        // var expfactory = new ExpFactory(uniqueId);

        /* These variables will be filled in given it's an mturk experiment
          expfactory.amazon_url="{{ amazon_host }}"
          expfactory.assignmentId="{{ assignment_id }}"
          expfactory.hitId="{{ hit_id }}"
        */

        function onFinish(data) {
          var finished_message = `
            <div id="finished_message" style="margin:100px">
                <h1>Experiment Complete</h1>
                <p>{{ end_message }}</p>
                <button id="next_experiment_button" type="button" class="btn btn-success">Next Experiment</button>
                <button type="button" id="redo_experiment_button" class="btn btn-danger">Redo Experiment</button>
            </div>`;
          // expfactory.recordTrialData(jsPsych.data.getData());
          let trialdata = {
            "uniqueid": 0,
            "current_trial": 0,
            "dateTime": (new Date().getTime()),
            "trialdata": jsPsych.data.getData()
          };
          $("body").append(finished_message);
          $(".display_stage").hide();
          $(".display_stage_background").hide();
          $("#redo_experiment_button").click(() => window.location.reload())
          $("#next_experiment_button").click(() => {
            // expfactory.djstatus = "FINISHED";
            $.ajax({
                type: "POST",
                contentType: "application/json",
                url : "{{ post_url }}",
                data : trialdata,
                dataType: "json",
                error: (error) => { console.log(error) },
                success: (data) => {
                  console.log("Finished!");
                  document.location = "{{next_page}}";
                }
              });
            });
        }

        // Start experiment when participant pushes button
        $("#start_experiment_button").click(() => {
           $("#instructions_modal").hide();
           $("#bootstrap_css").remove()
           jsPsych.init({
             timeline: {{ exp_id }}_experiment,
             on_finish: onFinish,
           });
        });

        {% if uniqueId %}
        $("#disagree_button").click(function(){
            document.location = "{{ exp_end }}"
        });
        {% endif %}

     });
  </script>

  <script>
    $(document).ready(function(){
       $("#start_experiment_button").click();
    });
  </script>

</body>
</html>
