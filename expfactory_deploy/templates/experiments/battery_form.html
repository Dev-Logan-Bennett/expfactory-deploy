{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
    {% if object.pk %}
        <h2> Update Battery </h2>
    {% else %}
        <h2>Create Battery</h2>
    {% endif %}
    <form id="experiment_instance_table" method="post" action="">
    <input class="btn btn-primary" type="submit" name="action" value="submit"/>
    {% crispy form %}
    <h3>Experiments</h3>
    <nav>
      <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <a class="nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Available Experiments</a>
        <a class="nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Selected</a>
      </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
      <div class="tab-pane active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
        <table id="experiment-repo-table">
          <thead>
            <tr>
              <th> </th>
              <th>Name</th>
              <th>Origin</th>
            </tr>
          </thead>
          <tbody>
            {% for exp_repo in experiment_repo_list %}
            <tr>
              <td>
                <input type="checkbox" id="{{ exp_repo.id }}" value="{{ exp_repo.id }}" class="exp_repo_checkbox">
              </td>
              <td>{{ exp_repo.name }}</td>
              <td>{{ exp_repo.origin }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
    <div class="tab-pane" id="nav-profile">
        <table id="exp_instance_table">
          <thead>
            <tr>
              <th>Order</th>
              <th>Note</th>
              <th>Commit</th>
              <th>Origin</th>
            </tr>
          </thead>
          <tbody id="exp_instance_tbody">
          {% for form in exp_instance_formset.forms %}
            <tr>
              <td> {{ form.ORDER }} </td>
              <td> {{ form.note }} </td>
              <td> {{ form.commit }} </td>
              <td> {{ form.experiment_repo_id }} {{form.id }} </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {{ exp_instance_formset.management_form }}
    </div>
    </form>
  </div>
{% endblock %}


{% block inline_javascript %}
{{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script>
  function updateOrder() {
    const rows = document.querySelectorAll('#exp_instance_tbody tr');
    rows.forEach((row) => {
      row.setAttribute("data-id", row.rowIndex - 1)
      row.children[0].querySelector('input').value = row.rowIndex - 1
      // row.children[0].innerText = row.rowIndex
    })
  }

  Sortable.create(exp_instance_tbody,{
    onUpdate: function(evt) {
      updateOrder()
    }
  })
  const form_count_id = "id_form-TOTAL_FORMS"
  const form_table_id = "exp_instance_tbody"
  const order_template = `{{ exp_instance_formset.empty_form.ORDER }}`
  const note_template = `{{ exp_instance_formset.empty_form.note }}`
  const commit_template = `{{ exp_instance_formset.empty_form.commit }}`
  const origin_template = `{{ exp_instance_formset.empty_form.experiment_repo_id }}`
  const empty_prefix = '__prefix__'


  function increment_form_count() {
    const elem = document.getElementById(form_count_id)
    elem.value++
    return elem.value
  }

  function decrement_form_count() {
    const elem = document.getElementById(form_count_id)
    if (elem.value === 0) {
      return 0
    }
    elem.value--
    return elem.value
  }

  function add_row() {
    const prefix = increment_form_count() - 1
    row = document.getElementById(form_table_id).insertRow()
    row.setAttribute("data-id", row.rowIndex - 1)
    row.insertCell().innerHTML = order_template.replaceAll(empty_prefix, prefix)
    row.insertCell().innerHTML = note_template.replaceAll(empty_prefix, prefix)
    row.insertCell().innerHTML = commit_template.replaceAll(empty_prefix, prefix)
    row.insertCell().innerHTML = origin_template.replaceAll(empty_prefix, prefix)
    return row
  }

  function remove_row() {
  }

  /* When we select an experiment from the table, update the select input used
     by django.
   */
  function selectFromCheckbox(event) {
    const value = event.target.value
    const checked = event.target.checked
    if (checked) {
      if (document.querySelectorAll(`#${form_table_id} select`).any(select => select.value === value)) {
        contine;
      } else {
        const row = add_row()
      }
    } else {
      if (document.querySelectorAll(`#${form_table_id} select`).any(select => select.value === value)) {
        remove_row()
      }
    }
    updateOrder()
  }

  /* To run on initial load, assumes that we are using experiment's database
     IDs as the value for options and as the checkbox id attribute
   */
  function checkBoxesFromSelect() {
    document.querySelectorAll(`#${form_table_id} select`).forEach(opt => {
      const cb = document.getElementById(String(opt.value))
      cb.checked = true
    })
  }
  checkBoxesFromSelect()

  const exp_repo_checkboxes = document.querySelectorAll(".exp_repo_checkbox")
  exp_repo_checkboxes.forEach(x => x.addEventListener("change", selectFromCheckbox))
  </script>

{% endblock %}
