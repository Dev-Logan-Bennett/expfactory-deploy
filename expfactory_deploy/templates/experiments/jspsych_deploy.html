<html>
  {# load static from staticfiles #}
  <head>
    <title>The Experiment Factory</title>
    <meta charset="utf-8" />
    <script src="/deployment/non_repo/default/static/js/jquery.min.js"></script>
    <script src="/deployment/non_repo/default/static/js/bootstrap.min.js"></script>
    {{ experiment_load | safe }}
{% csrf_token %}
  </head>
  <body>
    <button
      id="start_experiment_button"
      type="button"
      class="btn hidden"
      hidden
    ></button>
    <script>
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
          console.log("cookie")
          console.log(csrftoken)

          <!-- {# include "experiments/preview_battery_runjs.html" #} -->
          /* These variables will be filled in given it's an mturk experiment
            expfactory.amazon_url="{{ amazon_host }}"
            expfactory.assignmentId="{{ assignment_id }}"
            expfactory.hitId="{{ hit_id }}"
          */

          function onFinish(data) {
            var finished_message = `
              <div id="finished_message" style="margin:100px">
                  <h1>Experiment Complete</h1>
                  <p>{{ end_message }}</p>
                  <button id="next_experiment_button" type="button" class="btn btn-success">Next Experiment</button>
              </div>`;

            if (jsPsych.data.hasOwnProperty('getData')) {
              data = jsPsych.data.getData()
            } else {
              data = jsPsych.data.get().json()
            }

            let trialdata = {
              "uniqueid": "{{ uniqueId }}",
              "current_trial": 0,
              "dateTime": (new Date().getTime()),
              "trialdata": data,
              "status": "finished"
            };
            $("body").append(finished_message);
            $(".display_stage").hide();
            $(".display_stage_background").hide();
            $("#redo_experiment_button").click(() => window.location.reload())
            $.ajax({
                type: "POST",
                contentType: "application/json",
                headers: {'X-CSRFToken': csrftoken},
                url : "{{ post_url }}",
                data : JSON.stringify(trialdata),
                error: (error) => {
                  console.log(error)
                },
                dataType: 'text',
                success: (data) => {
                  $("#next_experiment_button").click(() => {
                    console.log("Finished!");
                    location.reload()
                  })
                }
              });
          }

          // Start experiment when participant pushes button
          $("#start_experiment_button").click(() => {
             $("#instructions_modal").hide();
             $("#bootstrap_css").remove()
              try {
                jsPsych.init({
                  timeline: {{ exp_id }}_experiment,
                  on_finish: onFinish
                });
              } catch {
                jsPsych = initJsPsych({on_finish: onFinish})
                {{ exp_id }}_init()
                jsPsych.run({{ exp_id }}_experiment)
             }
          });

          {% if uniqueId %}
          $("#disagree_button").click(function(){
              document.location = "{{ exp_end }}"
          });
          {% endif %}
    </script>

    <script>
      $(document).ready(function () {
        $("#start_experiment_button").click();
      });
    </script>
  </body>
</html>
